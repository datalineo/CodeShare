# ---------------------
# Install these modules to run the below code
#Install-Module -Name msrcsecurityupdates -force
#Import-module msrcsecurityupdates
# ---------------------

$storageaccountname = "lineointernal"
$resourcegroupname = "DatalineoInternal"
$key = "p27xEAlM5a/9yKhYPRf75ThG7fVPrcqJFNxu2He2l2+Yx/T5UXZhHj3tovcSExR7yudiK+jSWFjDtgHUEeTG/w=="
$containername = "msrcsecurityupdates"


$context = New-AzStorageContext -StorageAccountName $storageaccountname -StorageAccountKey $key 


[datetime]$StartDate = "1-jan-2020"
[datetime]$EndDate = "1-mar-2020"
#$EndDate = Get-Date -Day 01
Set-MSRCApiKey -ApiKey "4eb08d3a00224a6eade33fddac57d370" -Verbose


for($i = $StartDate; $i -lt $EndDate; $i=$i.AddMonths(1))
{
    $month = $i.ToString("yyyy-MMM")
    $monthfile = $i.ToString("yyyyMM")
    $filename = "MSRCSecurityUpdates_"+$monthfile+".html"
    $outfile = "c:\temp\"+$filename
    Get-MsrcCvrfDocument -ID $month -Verbose | Get-MsrcSecurityBulletinHtml -Verbose | Out-File $outfile
    Set-AzStorageBlobContent -File $outfile -Container $containerName -Blob $filename  -Context $context -Force
    Remove-Item $outfile
}
